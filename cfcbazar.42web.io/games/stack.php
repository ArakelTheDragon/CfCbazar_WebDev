<?phpsession_start();if (!isset($_SESSION['email'])) {  header('Location: /login.php');  exit;}require __DIR__ . '/../config.php';$conn = new mysqli($servername, $username, $password, $dbname);if ($conn->connect_error) die('DB error');$email = $_SESSION['email'];// Handle AJAXif ($_SERVER['REQUEST_METHOD'] === 'POST') {  $action = $_POST['action'] ?? '';  if ($action === 'deduct') {    $conn->query("UPDATE workers SET tokens_earned = GREATEST(tokens_earned - 0.001, 0) WHERE email = '$email'");    exit('deducted');  }  if ($action === 'reward' && intval($_POST['score']) >= 150) {    $conn->query("UPDATE workers SET tokens_earned = tokens_earned + 1 WHERE email = '$email'");    exit('rewarded');  }  exit('ok');}// Get current balance$res = $conn->query("SELECT tokens_earned FROM workers WHERE email = '$email' LIMIT 1");$tokens = $res->num_rows ? $res->fetch_assoc()['tokens_earned'] : 0;?><!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8" />  <meta name="viewport"        content="width=device-width, initial-scale=1.0, user-scalable=no" />  <title>Token Tower</title>  <style>    html, body {      margin: 0; padding: 0;      font-family: sans-serif;      background: #1a1a1a;      color: white;      display: flex; flex-direction: column;      align-items: center;    }    #hud {      width: 90vw;      display: flex; justify-content: space-between;      margin-top: 1vh; font-size: 5vw;    }    #balance { font-size: 4vw; margin-top: 0.5vh; }    #game {      position: relative;      width: 90vw; height: 80vh;      background: #111;      margin-top: 1vh;      overflow: hidden;      border: 3px solid #333;    }    .block {      position: absolute;      height: 5vh;      background: #32cd32;      left: 0;    }    button {      margin-top: 1vh;      font-size: 5vw;      padding: 1vh 4vw;      background: #444; color: white;      border: none;      border-radius: 10px;    }    button:active { background: #666; }    #message {      position: absolute;      top: 50%; left: 50%;      transform: translate(-50%, -50%);      text-align: center;      font-size: 6vw;      display: none;    }  </style></head><body>  <div id="hud">    <div>Score: <span id="score">0</span></div>    <div>Time: <span id="timer">30</span>s</div>  </div>  <div id="balance">Balance: <span id="wtBalance"><?= number_format($tokens, 3) ?></span> WT</div>  <div id="game">    <div id="message"></div>  </div>  <button onclick="dropBlock()">DROP</button>  <script>    const game = document.getElementById('game');    const scoreEl = document.getElementById('score');    const timerEl = document.getElementById('timer');    const msgEl = document.getElementById('message');    const balEl = document.getElementById('wtBalance');    let tower = [], current, direction, speed, level = 0, gameOver = false;    let timeLeft = 30, gameInterval, timerInterval;    function init() {      gameOver = false;      level = 0;      timeLeft = 30;      tower = [];      game.innerHTML = ''; game.appendChild(msgEl);      scoreEl.textContent = 0;      timerEl.textContent = timeLeft;      msgEl.style.display = 'none';      spawnBlock();      gameInterval = requestAnimationFrame(animate);      timerInterval = setInterval(() => {        timeLeft--;        timerEl.textContent = timeLeft;        if (timeLeft <= 0) endGame();      }, 1000);    }    function spawnBlock() {      const width = level === 0 ? game.clientWidth : tower[level - 1].offsetWidth;      const y = game.clientHeight - (level + 1) * 5 * game.clientHeight / 100;      current = document.createElement('div');      current.className = 'block';      current.style.width = width + 'px';      current.style.top = y + 'px';      current.style.left = '0px';      game.appendChild(current);      direction = 1;      speed = 2 + level / 10;    }    function animate() {      if (gameOver) return;      const maxX = game.clientWidth - current.offsetWidth;      let x = parseFloat(current.style.left) || 0;      x += direction * speed;      if (x < 0) { x = 0; direction = 1; }      if (x > maxX) { x = maxX; direction = -1; }      current.style.left = x + 'px';      for (const b of tower) {        const ty = parseFloat(b.style.top);        b.style.top = (ty + speed * 0.15) + 'px';      }      current.style.top = (parseFloat(current.style.top) + speed * 0.15) + 'px';      gameInterval = requestAnimationFrame(animate);    }    function dropBlock() {      if (gameOver) return init();      // Deduct 0.001      fetch(window.location.href, {        method: 'POST',        headers: {'Content-Type': 'application/x-www-form-urlencoded'},        body: 'action=deduct'      }).then(() => {        const bal = parseFloat(balEl.textContent);        balEl.textContent = (bal - 0.001).toFixed(3);      });      const prev = tower[level - 1];      const curr = current;      const cx = curr.offsetLeft, cw = curr.offsetWidth;      if (level === 0) {        tower.push(curr);      } else {        const px = prev.offsetLeft, pw = prev.offsetWidth;        const overlapStart = Math.max(px, cx);        const overlapEnd = Math.min(px + pw, cx + cw);        const overlapWidth = overlapEnd - overlapStart;        if (overlapWidth <= 0) {          endGame();          return;        }        curr.style.left = overlapStart + 'px';        curr.style.width = overlapWidth + 'px';        tower.push(curr);      }      level++;      scoreEl.textContent = level;      spawnBlock();    }    function endGame() {      gameOver = true;      cancelAnimationFrame(gameInterval);      clearInterval(timerInterval);      if (level >= 150) {        fetch(window.location.href, {          method: 'POST',          headers: {'Content-Type': 'application/x-www-form-urlencoded'},          body: 'action=reward&score=' + level        }).then(() => {          const bal = parseFloat(balEl.textContent);          balEl.textContent = (bal + 1).toFixed(3);        });        msgEl.innerHTML = ` You 