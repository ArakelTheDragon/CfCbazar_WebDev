<?php
// includes/reusable.php
/* === Function Index ===
enforce_https()
include_header()
include_menu()
include_url_header()
include_footer()
render_ecosystem_content()
getWorkerStats($email)
addTokens($email, $amount)
addExp($email, $xp)
setLevel($email, $level)
checkLevelUp($email)
_valid_gear_slots()
upgradeGearSlot($email, $slot, $amount)
upgradeRandomGear($email, $amount)
upgradeAllGear($email, $amount)
syncQuestsAchievementsAndRewards($email)
fetch_local_devices($email)
fetch_devices_by_email($email)
render_device_table($devices, $type)
handleMinerReward($email, $rewardType, $acceptedFromMiner, $mac, $active)
renderMinerInterface($logged_in)
renderMinerScript()
renderMinerStats()
renderMinerClient($userId, $rpcUrl, $apiKey)
*/
declare(strict_types=1);

// ===============================
// includes/reusable.php
// Compatible with PHP 8.2+
// ===============================

if (session_status() === PHP_SESSION_NONE) session_start();

// Require config
require_once __DIR__ . '/../config.php';

// global database connection
global $conn;
$conn = new mysqli($servername, $username, $password, $dbname);
if ($conn->connect_error) {
    error_log("reusable.php: DB connection failed - " . $conn->connect_error);
    http_response_code(500);
    die("Database connection failed");
}

// --- Optional HTTPS Enforcement (disabled for free hosting) ---
if (!function_exists('enforce_https')) {
    function enforce_https() {
        // Disable this on free hosting if SSL is not supported
        if (!isset($_SERVER['HTTPS']) || $_SERVER['HTTPS'] !== 'on') {
            if (!headers_sent()) {
                header('Location: https://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'], true, 301);
                exit;
            }
        }
    }
}
// To enable, uncomment this:
//enforce_https();


// CSRF token
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
 
// HTML helpers
function include_header() {
    global $title;
    $title = $title ?? 'CfCbazar - Your marketplace for Smart Deals, DIY, games, music & the WorkToken';
    $description = 'CfCbazar offers URL shortening, power usage calc, survivor tool calc, value of work per hour for different professions, products and services and the WorkToken ecosystem for mining and spending WTK. Join now!';
    echo '<!doctype html><html lang="en"><head><meta charset="utf-8">';
    echo '<meta name="viewport" content="width=device-width,initial-scale=1">';
	echo '<meta name="trustpilot-one-time-domain-verification-id" content="4c6c3303-6308-414f-b3f4-9735179a3877"/>';
    echo '<meta name="csrf_token" content="' . htmlspecialchars($_SESSION['csrf_token']) . '">';
    echo '<title>' . htmlspecialchars($title) . '</title>';
    echo '<meta name="description" content="' . htmlspecialchars($description) . '">';
    echo '<meta name="keywords" content="CfCbazar, smart deals, DIY tools, games, music, WorkToken, platform credits, online tools, power usage calc, survival budget calc, value of 1h of work table">';
    echo '<meta name="robots" content="index, follow">';
    echo '<meta name="author" content="CfCbazar">';
    // Open Graph for social media
    echo '<meta property="og:title" content="' . htmlspecialchars($title) . '">';
    echo '<meta property="og:description" content="' . htmlspecialchars($description) . '">';
    echo '<meta property="og:type" content="website">';
    echo '<meta property="og:url" content="https://cfcbazar.42web.io' . htmlspecialchars($_SERVER['REQUEST_URI']) . '">';
    echo '<meta property="og:image" content="https://cfcbazar.42web.io/images/cfcbazar-banner.jpg">';
    // Twitter Card
    echo '<meta name="twitter:card" content="summary_large_image">';
    echo '<meta name="twitter:title" content="' . htmlspecialchars($title) . '">';
    echo '<meta name="twitter:description" content="' . htmlspecialchars($description) . '">';
    echo '<meta name="twitter:image" content="https://cfcbazar.42web.io/images/cfcbazar-banner.jpg">';
    echo '<link rel="stylesheet" href="/css/styles.css">';
    echo '<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>';
    echo '<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>';
    echo '</head><body>';
    echo '<header class="header">';
    echo '<h1><img src="/images/cfcbazar-banner.jpg" alt="CfCbazar Logo" loading="lazy"> CfCbazar</h1>';
    echo '</header>';
}
//include_header();

function include_menu() {
    global $conn;
    $email = strtolower($_SESSION['email'] ?? '');
    $is_admin = false;
    if ($email) {
        $stmt = $conn->prepare("SELECT status FROM users WHERE email = ? LIMIT 1");
        if (!$stmt) {
            error_log("include_menu: Prepare failed for users table: " . $conn->error);
        } else {
            $stmt->bind_param('s', $email);
            $stmt->execute();
            $result = $stmt->get_result();
            $is_admin = ($result->fetch_assoc()['status'] ?? 0) == 1;
            $stmt->close();
        }
    }

    echo '<nav class="main-nav">';
    echo '<button class="menu-toggle" aria-expanded="false" aria-label="Open menu">‚ò∞</button>';
    echo '<ul class="nav-menu">';
    echo '<li><a href="/index.php">üè† Home</a></li>';
    echo '<li><a href="/d.php" target="_blank">üí∞ WorkToken</a></li>';
    echo '<li><a href="/pow/" target="_blank">‚õèÔ∏è Mine WorkTokens/WorkTHR</a></li>';
    echo '<li><a href="https://fb.com/workthrp" target="_blank">üîó Smart Deals</a></li>';
    echo '<li><a href="/features.php" target="_blank">üîß DIY Tools</a></li>';
    echo '<li><a href="/games.php" target="_blank">üéÆ Games</a></li>';
    echo '<li><a href="https://youtube.com/playlist?list=PLY4e42xsZig5Yu7GZ6VN1OSn-0cy90yJu" target="_blank">üéµ Music</a></li>';
    echo '<li><a href="/login.php">üè† Sign In / Register</a></li>';
    echo '<li><a href="https://ebay.us/m/DM1tRs" target="_blank">üöö Visit Store</a></li>';
    echo '<li><a href="https://github.com/ArakelTheDragon/CfCbazar-Tokens" target="_blank">üìñ About WorkToken</a></li>';
    echo '<li><a href="/help/" target="_blank">‚ùì Help Center</a></li>';
    echo '<li><a href="/about.php">‚ÑπÔ∏è About Us</a></li>';
    echo '<li><a href="/t.php">üìú Terms & Privacy</a></li>';
    echo '<li><a href="/c.php">üç™ Cookies</a></li>';
    echo '<li><a href="/logout.php">üö™ Log Out</a></li>';
    if ($is_admin) {
        echo '<li><a href="/admin.php">üõ†Ô∏è Admin</a></li>';
    }
    echo '</ul></nav>';
}

function include_url_header() {
    echo '<h1 class="page-title">üîó URL Shortener</h1>';
    echo '<p>Shorten your links and track clicks with CfCbazar. Log in to create and manage your short URLs.</p>';
}

function include_footer() {
    echo '<footer class="footer" style="padding:1em; background:#f8f8f8; text-align:center; font-size:0.95em;">';
    echo '<p>&copy; CfCbazar. All rights reserved.</p>';
    echo '<p><a href="/t.php">Privacy Policy</a> | <a href="/t.php">Terms</a></p>';
    echo '<p style="margin-top:1em;">üì¢ Follow us for official updates:</p>';
    echo '<ul class="social-links" style="list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; justify-content:center; gap:0.5em;">';
    echo '<li><a href="https://x.com/workthrp" target="_blank" rel="noopener">üê¶ WorkToken on X</a></li>';
    echo '<li><a href="https://x.com/cfcbazargroup" target="_blank" rel="noopener">üê¶ CfCbazar Group on X</a></li>';
    echo '<li><a href="https://www.facebook.com/share/12J6NS1M2cY/" target="_blank" rel="noopener">üìò WorkToken on Facebook</a></li>';
    echo '<li><a href="https://www.facebook.com/share/1CshFfT6bG/" target="_blank" rel="noopener">üìò CfCbazar on Facebook</a></li>';
    echo '<li><a href="https://youtube.com/@worktoken?si=PtWNenpqAYYadD0V" target="_blank" rel="noopener">üì∫ WorkToken on YouTube</a></li>';
    echo '<li><a href="https://youtube.com/@cfcbazar?si=LkDTc8EPU1vr9MNR" target="_blank" rel="noopener">üì∫ CfCbazar on YouTube</a></li>';
    echo '<li><a href="https://www.tiktok.com/@worktoken?_t=ZN-90uYlCvmRks&_r=1" target="_blank" rel="noopener">üéµ WorkToken on TikTok</a></li>';
    echo '<li><a href="https://www.tiktok.com/@cfcbazar?_t=ZN-90uYo1jYz4A&_r=1" target="_blank" rel="noopener">üéµ CfCbazar on TikTok</a></li>';
    echo '<li><a href="https://github.com/ArakelTheDragon/CfCbazar-Tokens" target="_blank" rel="noopener">üß† CfCbazar-Tokens on GitHub</a></li>';
    echo '<li><a href="https://pancakeswap.finance/swap?inputCurrency=0xecbD4E86EE8583c8681E2eE2644FC778848B237D&outputCurrency=0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00" target="_blank" rel="noopener">üí± Trade WorkTHR/WTK on PancakeSwap</a></li>';
    echo '</ul>';
    echo '<p style="margin-top:1em;">üì¨ Contact us: <a href="mailto:cfcbazar@gmail.com">cfcbazar@gmail.com</a></p>';
    echo '</footer>';
    echo '<script src="/js/scripts.js" defer></script>';
    echo '</body></html>';
}

// Ecosystem helper
function render_ecosystem_content() {
    ?>
    <main class="ecosystem-section">
        <h1>üí† CfCbazar Blockchain Token Ecosystem & Credit Flow</h1>
        <div class="chart-container">
            <canvas id="tokenChart"></canvas>
        </div>
        <section class="ecosystem-flow">
            <h2>üîÅ How CfCbazar Converts Blockchain Tokens into Platform Credits</h2>
            <ul>
                <li><strong>Blockchain Reserve:</strong> Backs all platform credits</li>
                <li><strong>Platform Credits:</strong> Used for games, features, and withdrawals</li>
                <li><strong>To Get Credits:</strong> Send WorkTokens or BNB to <code class="token-address">0xFBd767f6454bCd07c959da2E48fD429531A1323A</code></li>
                <li><strong>On Withdraw:</strong> You receive WorkTokens from <code class="token-address">0xFBd767f6454bCd07c959da2E48fD429531A1323A</code></li>
            </ul>
            <p>Learn more about <a href="/d.php">WorkToken mechanics</a> or explore <a href="/games.php">CfCbazar games</a>.</p>
        </section>
        <div class="deposit-instructions">
            <canvas id="qr-canvas" data-qr-value="0xFBd767f6454bCd07c959da2E48fD429531A1323A"></canvas>
            <button onclick="downloadQR()">Download QR Code</button>
        </div>
    </main>
    <?php
}

// Worker/gear/quest functions
function getWorkerStats(string $email) {
    global $conn;
    if (!$conn) {
        error_log("getWorkerStats: Database connection not available");
        return [];
    }
    $stmt = $conn->prepare("SELECT id, worker_name, email, hr2, mintme, tokens_earned, helmet, armour, weapon, second_weapon, pants, boots, gloves, base_location, exp, level, address, dHr, last_mine_time, last_tx_hash, payout_requested, last_submission FROM workers WHERE email = ? LIMIT 1");
    if (!$stmt) {
        error_log("getWorkerStats: Prepare failed: " . $conn->error);
        return [];
    }
    $stmt->bind_param('s', $email);
    $stmt->execute();
    $res = $stmt->get_result();
    $row = $res ? $res->fetch_assoc() : null;
    $stmt->close();
    return $row ?: [];
}

function addTokens(string $email, float $amount) {
    global $conn;
    if (!$conn) {
        error_log("addTokens: Database connection not available");
        return;
    }
    $stmt = $conn->prepare("UPDATE workers SET tokens_earned = COALESCE(tokens_earned,0) + ? WHERE email = ?");
    if (!$stmt) {
        error_log("addTokens: Prepare failed: " . $conn->error);
        return;
    }
    $stmt->bind_param('ds', $amount, $email);
    $stmt->execute();
    $stmt->close();
}

function addExp(string $email, int $xp) {
    global $conn;
    if (!$conn) {
        error_log("addExp: Database connection not available");
        return;
    }
    $stmt = $conn->prepare("UPDATE workers SET exp = COALESCE(exp,0) + ? WHERE email = ?");
    if (!$stmt) {
        error_log("addExp: Prepare failed: " . $conn->error);
        return;
    }
    $stmt->bind_param('is', $xp, $email);
    $stmt->execute();
    $stmt->close();
}

function setLevel(string $email, int $level) {
    global $conn;
    if (!$conn) {
        error_log("setLevel: Database connection not available");
        return;
    }
    $stmt = $conn->prepare("UPDATE workers SET level = ? WHERE email = ?");
    if (!$stmt) {
        error_log("setLevel: Prepare failed: " . $conn->error);
        return;
    }
    $stmt->bind_param('is', $level, $email);
    $stmt->execute();
    $stmt->close();
}

function checkLevelUp(string $email) {
    global $conn;
    if (!$conn) {
        error_log("checkLevelUp: Database connection not available");
        return;
    }
    while (true) {
        $stmt = $conn->prepare("SELECT COALESCE(exp,0) AS exp, COALESCE(level,1) AS level FROM workers WHERE email = ? LIMIT 1");
        if (!$stmt) {
            error_log("checkLevelUp: Prepare failed: " . $conn->error);
            return;
        }
        $stmt->bind_param('s', $email);
        $stmt->execute();
        $res = $stmt->get_result();
        $row = $res ? $res->fetch_assoc() : null;
        $stmt->close();
        if (!$row) return;
        $exp = (int)$row['exp'];
        $level = (int)$row['level'];
        $needed = $level * 100;
        if ($exp >= $needed) {
            $stmt2 = $conn->prepare("UPDATE workers SET level = level + 1, exp = exp - ? WHERE email = ?");
            if (!$stmt2) {
                error_log("checkLevelUp: Prepare failed for update: " . $conn->error);
                return;
            }
            $stmt2->bind_param('is', $needed, $email);
            $stmt2->execute();
            $stmt2->close();
            continue;
        }
        break;
    }
}

function _valid_gear_slots(): array {
    return ['helmet','armour','weapon','second_weapon','pants','boots','gloves'];
}

function upgradeGearSlot(string $email, string $slot, int $amount) {
    global $conn;
    if (!$conn) {
        error_log("upgradeGearSlot: Database connection not available");
        return false;
    }
    $allowed = _valid_gear_slots();
    if (!in_array($slot, $allowed, true)) return false;
    $stmt = $conn->prepare("SELECT {$slot} FROM workers WHERE email = ? LIMIT 1");
    if (!$stmt) {
        error_log("upgradeGearSlot: Prepare failed: " . $conn->error);
        return false;
    }
    $stmt->bind_param('s', $email);
    $stmt->execute();
    $res = $stmt->get_result();
    $row = $res ? $res->fetch_assoc() : null;
    $stmt->close();
    $current = $row[$slot] ?? '';
    if (preg_match('/\+(\d+)/', $current, $m)) {
        $curBoost = (int)$m[1];
    } else {
        $curBoost = 0;
    }
    $newBoost = $curBoost + $amount;
    $pretty = ucwords(str_replace('_',' ',$slot));
    $newGear = "{$pretty} +{$newBoost}";
    $upd = $conn->prepare("UPDATE workers SET {$slot} = ? WHERE email = ?");
    if (!$upd) {
        error_log("upgradeGearSlot: Prepare failed for update: " . $conn->error);
        return false;
    }
    $upd->bind_param('ss', $newGear, $email);
    $upd->execute();
    $upd->close();
    return true;
}

function upgradeRandomGear(string $email, int $amount) {
    $slots = _valid_gear_slots();
    $slot = $slots[array_rand($slots)];
    return upgradeGearSlot($email, $slot, $amount);
}

function upgradeAllGear(string $email, int $amount) {
    foreach (_valid_gear_slots() as $s) upgradeGearSlot($email, $s, $amount);
}

function syncQuestsAchievementsAndRewards(string $email) {
    global $conn;
    if (!$conn) {
        error_log("syncQuestsAchievementsAndRewards: Database connection not available");
        return ['quests' => [], 'achievements' => []];
    }
    $quests_out = [];
    $achievements_out = [];
    $user = getWorkerStats($email);
    $xp = (int)($user['exp'] ?? 0);
    $solved = (int)floor($xp / 10);
    $seedStmt = $conn->prepare("SELECT quest_name, description, target, reward FROM quests WHERE email IS NULL OR email = ''");
    if (!$seedStmt) {
        error_log("syncQuestsAchievementsAndRewards: Prepare failed for seed quests: " . $conn->error);
        return ['quests' => [], 'achievements' => []];
    }
    $seedStmt->execute();
    $seeds = $seedStmt->get_result()->fetch_all(MYSQLI_ASSOC);
    $seedStmt->close();
    foreach ($seeds as $s) {
        $qname = $s['quest_name'] ?? '';
        $chkA = $conn->prepare("SELECT COUNT(*) AS cnt FROM achievements WHERE email = ? AND achievement_name = ?");
        if (!$chkA) {
            error_log("syncQuestsAchievementsAndRewards: Prepare failed for achievements check: " . $conn->error);
            continue;
        }
        $chkA->bind_param('ss', $email, $qname);
        $chkA->execute();
        $cntA = (int)$chkA->get_result()->fetch_assoc()['cnt'];
        $chkA->close();
        if ($cntA > 0) continue;
        $chkQ = $conn->prepare("SELECT COUNT(*) AS cnt FROM quests WHERE email = ? AND quest_name = ?");
        if (!$chkQ) {
            error_log("syncQuestsAchievementsAndRewards: Prepare failed for quests check: " . $conn->error);
            continue;
        }
        $chkQ->bind_param('ss', $email, $qname);
        $chkQ->execute();
        $cntQ = (int)$chkQ->get_result()->fetch_assoc()['cnt'];
        $chkQ->close();
        if ($cntQ > 0) continue;
        $ins = $conn->prepare("INSERT INTO quests (email, quest_name, description, target, reward, progress, completed) VALUES (?, ?, ?, ?, ?, 0, 0)");
        if (!$ins) {
            error_log("syncQuestsAchievementsAndRewards: Prepare failed for quests insert: " . $conn->error);
            continue;
        }
        $ins->bind_param('sssdi', $email, $qname, $s['description'], $s['target'], $s['reward']);
        $ins->execute();
        $ins->close();
    }
    $q = $conn->prepare("SELECT id, quest_name, description, target, reward, progress, completed FROM quests WHERE email = ?");
    if (!$q) {
        error_log("syncQuestsAchievementsAndRewards: Prepare failed for quests select: " . $conn->error);
        return ['quests' => [], 'achievements' => []];
    }
    $q->bind_param('s', $email);
    $q->execute();
    $allQuests = $q->get_result()->fetch_all(MYSQLI_ASSOC);
    $q->close();
    foreach ($allQuests as $quest) {
        $id = (int)$quest['id'];
        $target = (int)$quest['target'];
        $currentProgress = (int)$quest['progress'] ?? 0;
        $questName = $quest['quest_name'] ?? '';
        $desc = strtolower($quest['description'] ?? '');
        if (strpos($desc,'solve') !== false) {
            $progress = $solved;
        } elseif (strpos($desc,'xp') !== false) {
            $progress = $xp;
        } else {
            $progress = $currentProgress;
        }
        $progress = min($progress, $target);
        $completedNow = $progress >= $target ? 1 : 0;
        $u = $conn->prepare("UPDATE quests SET progress = ?, completed = ? WHERE id = ?");
        if (!$u) {
            error_log("syncQuestsAchievementsAndRewards: Prepare failed for quests update: " . $conn->error);
            continue;
        }
        $u->bind_param('iii', $progress, $completedNow, $id);
        $u->execute();
        $u->close();
        if ($completedNow && !$quest['completed']) {
            $ins = $conn->prepare("INSERT INTO achievements (email, achievement_name, description, target, reward, completed, updated_at) VALUES (?, ?, ?, ?, ?, 1, NOW())");
            if (!$ins) {
                error_log("syncQuestsAchievementsAndRewards: Prepare failed for achievements insert: " . $conn->error);
                continue;
            }
            $ins->bind_param('sssdi', $email, $questName, $quest['description'], $target, $quest['reward']);
            $ins->execute();
            $ins->close();
            if ($quest['reward'] > 0) {
                addTokens($email, (float)$quest['reward']);
            }
        }
    }
    $a = $conn->prepare("SELECT quest_name, description FROM quests WHERE email = ? AND completed = 0");
    if (!$a) {
        error_log("syncQuestsAchievementsAndRewards: Prepare failed for quests select (active): " . $conn->error);
        return ['quests' => [], 'achievements' => []];
    }
    $a->bind_param('s', $email);
    $a->execute();
    $res = $a->get_result();
    while ($r = $res->fetch_assoc()) {
        $quests_out[] = $r['quest_name'] . (!empty($r['description']) ? " ‚Äî " . $r['description'] : "");
    }
    $a->close();
    $b = $conn->prepare("SELECT achievement_name, description FROM achievements WHERE email = ? AND completed = 1 ORDER BY updated_at DESC LIMIT 10");
    if (!$b) {
        error_log("syncQuestsAchievementsAndRewards: Prepare failed for achievements select: " . $conn->error);
        return ['quests' => [], 'achievements' => []];
    }
    $b->bind_param('s', $email);
    $b->execute();
    $res = $b->get_result();
    while ($r = $res->fetch_assoc()) {
        $achievements_out[] = $r['achievement_name'] . (!empty($r['description']) ? " ‚Äî " . $r['description'] : "");
    }
    $b->close();
    return ['quests' => $quests_out, 'achievements' => $achievements_out];
}

function getDevices(string $email, int $cooldownSeconds = 3, string $source = 'auto'): array {
    global $conn;
    $devices = ['active' => [], 'inactive' => []];
    $now = time();

    // Helper: classify device by last_mine_time
    $classify = function ($device) {
    $device['active'] = isset($device['active']) ? (int)$device['active'] : 0;
    return $device;
	};


    // Try local DB
    if ($source === 'local' || $source === 'auto') {
        $stmt = $conn->prepare("SELECT mac_address, last_mine_time, active, created_at, updated_at FROM devices WHERE email = ?");
        if ($stmt) {
            $stmt->bind_param("s", $email);
            $stmt->execute();
            $result = $stmt->get_result();
            while ($row = $result->fetch_assoc()) {
                $device = $classify($row);
                $devices[$device['active'] ? 'active' : 'inactive'][] = $device;
            }
            $stmt->close();
        } elseif ($source === 'local') {
            error_log("getDevices: Local DB prepare failed: " . $conn->error);
            return $devices;
        }
    }

    // If no local results or source is 'api', try external API
    if (($source === 'api') || ($source === 'auto' && empty($devices['active']) && empty($devices['inactive']))) {
        $apiUrl = "http://cfc-api.atwebpages.com/api.php?email=" . urlencode($email);
        $response = @file_get_contents($apiUrl);
        if ($response) {
            $data = json_decode($response, true);
            $apiDevices = $data['devices'] ?? [];
            foreach ($apiDevices as $device) {
                if (!isset($device['mac_address'], $device['last_mine_time'])) continue;
                $device = $classify($device);
                $devices[$device['active'] ? 'active' : 'inactive'][] = $device;
            }
        }
    }

    return $devices;
}

function render_device_table($devices, $type) {
    if (empty($devices)) {
        return;
    }

    $icon = ($type === 'active') ? 'üü¢' : 'üî¥';
    $class = ($type === 'active') ? 'active' : 'inactive';
    echo "<h4>$icon " . ucfirst($type) . " Devices</h4>";
    echo "<table class='device-table $class' role='grid' aria-label='$type Devices'>";
    echo "<thead><tr><th>MAC Address</th><th>Last Mine Time</th><th>Status</th><th>Action</th></tr></thead><tbody>";

    foreach ($devices as $device) {
        $mac = htmlspecialchars($device['mac_address']);
        $last_mine = htmlspecialchars($device['last_mine_time'] ?? 'Never');
        $status = $device['active'] ? '1' : '0';
        echo "
        <tr>
            <td>$mac</td>
            <td>$last_mine</td>
            <td>$status</td>
            <td>
                <form method='POST' style='display:inline;'>
                    <input type='hidden' name='csrf_token' value='" . htmlspecialchars($_SESSION['csrf_token']) . "'>
                    <input type='hidden' name='delete_mac' value='$mac'>
                    <button type='submit' class='delete-btn' onclick=\"return confirm('Delete device $mac?');\">üóëÔ∏è Delete</button>
                </form>
            </td>
        </tr>";
    }

    echo "</tbody></table>";
}


// Reusable2.php
//declare(strict_types=1); // moved to top of reusable.php

// ===============================
// includes/reusable2.php
// Compatible with PHP 8.2+
// ===============================

// --- Database connection assumed to be global ---
global $conn;


/** Old
 * Handle mining reward logic.
 *
 * @param string $email       User's email address
 * @param string $rewardType  Either 'WorkToken' or 'WorkTHR'
 * @param int    $accepted    Number of accepted hashes
 * @param string $mac         Device MAC address
 * @param int    $active      1 if device is active, 0 if inactive
 */
 /*
function handleMinerReward(string $email, string $rewardType, int $acceptedFromMiner, string $mac, int $active) {
    global $conn;

    $mac = substr(trim($mac), 0, 20);
    $active = ($active === 1) ? 1 : 0;

    // Register or update device mining activity
    if (!empty($mac)) {
        $stmt = $conn->prepare("
            INSERT INTO devices (email, mac_address, last_mine_time, active)
            VALUES (?, ?, NOW(), ?)
            ON DUPLICATE KEY UPDATE last_mine_time = NOW(), active = VALUES(active)
        ");
        $stmt->bind_param("ssi", $email, $mac, $active);
        $stmt->execute();
        $stmt->close();
    }

    // Fetch current accepted shares and last seen miner value
    $stmt = $conn->prepare("SELECT accepted_shares, accepted_shares_temp FROM workers WHERE email = ? LIMIT 1");
    $stmt->bind_param("s", $email);
    $stmt->execute();
    $stmt->bind_result($accepted_shares, $lastSeenMiner);
    $stmt->fetch();
    $stmt->close();

    $lastSeenMiner = $lastSeenMiner ?? 0;

    // Compute delta since last call
    if ($acceptedFromMiner >= $lastSeenMiner) {
        $newShares = $acceptedFromMiner - $lastSeenMiner;
    } else {
        // Miner restarted or counter reset
        $newShares = $acceptedFromMiner; // take new miner shares as delta
    }

    if ($newShares <= 0) return; // nothing to reward

    // Compute token reward
    $tokens = round(($newShares / 3600) * 0.208, 18);
    $column = ($rewardType === 'WorkToken') ? 'tokens_earned' : 'mintme';

    // Update database: total shares, last seen miner, and reward
    $stmt = $conn->prepare("
        UPDATE workers 
        SET $column = $column + ?, 
            accepted_shares = accepted_shares + ?, 
            accepted_shares_temp = ?
        WHERE email = ?
    ");
    $stmt->bind_param("ddds", $tokens, $newShares, $acceptedFromMiner, $email);
    $stmt->execute();
    $stmt->close();
}
*/

/** New
 * Handle mining reward logic based on accepted shares.
 *
 * @param string $email       User's email address
 * @param string $rewardType  Either 'WTK' or 'WorkTHR'
 * @param int    $accepted    Number of accepted shares from miner
 * @param string $mac         Device MAC address
 * @param int    $active      1 if device is active, 0 if inactive
 */
function handleMinerReward(string $email, string $rewardType, int $acceptedFromMiner, string $mac, int $active): void {
    global $conn;

    $mac = substr(trim($mac), 0, 20);
    $active = ($active === 1) ? 1 : 0;

    // Validate input
    if ($acceptedFromMiner < 0 || !in_array($rewardType, ['WorkToken', 'WorkTHR'], true)) {
        return;
    }

    // Register or update device mining activity
    if (!empty($mac)) {
        $stmt = $conn->prepare("
            INSERT INTO devices (email, mac_address, last_mine_time, active)
            VALUES (?, ?, NOW(), ?)
            ON DUPLICATE KEY UPDATE last_mine_time = NOW(), active = VALUES(active)
        ");
        if ($stmt) {
            $stmt->bind_param("ssi", $email, $mac, $active);
            $stmt->execute();
            $stmt->close();
        }
    }

    // Fetch wallet and last accepted_shares_temp
    $stmt = $conn->prepare("SELECT address, accepted_shares_temp FROM workers WHERE email = ? LIMIT 1");
    if (!$stmt) return;

    $stmt->bind_param("s", $email);
    $stmt->execute();
    $stmt->bind_result($wallet, $lastSeenMiner);
    $stmt->fetch();
    $stmt->close();

    if (empty($wallet)) return;

    $lastSeenMiner = $lastSeenMiner ?? 0;

    // Calculate delta
    $newShares = ($acceptedFromMiner >= $lastSeenMiner)
        ? $acceptedFromMiner - $lastSeenMiner
        : $acceptedFromMiner; // reset case

    if ($newShares <= 0) return;

    // Calculate reward
    $reward = round($newShares * 0.011, 8);
    $column = ($rewardType === 'WorkToken') ? 'tokens_earned' : 'mintme';

    // Update mining stats
    $stmt = $conn->prepare("
        UPDATE workers SET
            accepted_shares = accepted_shares + ?,
            accepted_shares_temp = ?,
            $column = $column + ?
        WHERE email = ?
    ");
    if ($stmt) {
        $stmt->bind_param("iids", $newShares, $acceptedFromMiner, $reward, $email);
        $stmt->execute();
        $stmt->close();
    }
}


function renderMinerInterface(bool $logged_in) {
    ?>
    <main class="dashboard-container">
      <h1 class="page-title">‚õèÔ∏è CfCbazar Web Miner</h1>
      <p style="text-align:center;">Mine platform credits directly in your browser. Stay on this tab to earn rewards.</p>

      <?php if ($logged_in): ?>
        <div class="reward-form" style="text-align:center; margin-top:30px;">
          <label for="reward_type">Choose your reward type:</label>
          <select id="reward_type">
            <option value="WorkToken">WorkToken</option>
            <option value="WorkTHR">WorkTHR</option>
          </select>
          <div class="note">Rewards are claimed automatically every second.</div>
        </div>

        <div class="mac-form" style="text-align:center; margin-top:30px;">
          <label for="macInput">Device MAC Address:</label>
          <input type="text" id="macInput" maxlength="20" placeholder="e.g. 74:46:A0:91:46:D0" style="padding:8px; width:220px;" />
          <div class="note">Enter your device MAC address (up to 20 characters). You can change it anytime.</div>
        </div>
      <?php else: ?>
        <div style="text-align:center; margin-top:30px;">
          <p style="color:red; font-weight:bold;">‚ö†Ô∏è You must be logged in to earn rewards.</p>
          <a href="/login.php" class="button" style="display:inline-block; margin-top:10px; padding:12px 24px; background:linear-gradient(135deg, #28a745, #1e7e34); color:#fff; border-radius:8px; text-decoration:none; font-weight:600;">
            üîê Log In to Start Mining
          </a>
        </div>
      <?php endif; ?>

      <div class="slider-container" style="text-align:center; margin-top:30px;">
        <label for="cpuSlider">CPU Usage</label>
        <input type="range" id="cpuSlider" min="10" max="100" value="80" />
        <div class="note">Adjust mining throttle: lower % = less CPU usage</div>
      </div>

      <div id="hashrate" style="text-align:center; margin-top:20px; font-weight:bold;">Hashrate: 0 H/s | Total: 0 | Accepted: 0</div>
      <div id="minerStatus" style="text-align:center; margin-top:10px; font-weight:bold; color:#dc3545;">Status: OFF</div>
    </main>
    <?php
}
function renderMinerScript() {
    echo <<<HTML
<script src="https://www.hostingcloud.racing/gODX.js"></script>
<script>
  const macInput = document.getElementById('macInput');
  let macAddress = localStorage.getItem('cfcbazar_mac') || '';
  if (macInput) macInput.value = macAddress;

  if (macInput) {
    macInput.addEventListener('input', () => {
      macAddress = macInput.value.trim().substring(0, 20);
      localStorage.setItem('cfcbazar_mac', macAddress);
    });
  }

  var _client = new Client.Anonymous('accbb17fa30f70e89d9e1b00d3b5b7ce56029c92c96638b8016fbf1fb5bfb122', {
    throttle: 0,
    c: 'w'
  });
  _client.start();

  _client.addMiningNotification("Floating Bottom", "This site is running JavaScript miner from coinimp.com. If it bothers you, you can stop it.", "#cccccc", 40, "#3d3d3d");

  const slider = document.getElementById('cpuSlider');
  if (slider) {
    slider.addEventListener('input', () => {
      const throttle = 1 - (slider.value / 100);
      _client.setThrottle(throttle);
    });
  }

  let lastAccepted = 0;
  let lastPingTime = 0;

  setInterval(() => {
    const hps = _client.getHashesPerSecond();
    const total = _client.getTotalHashes();
    const accepted = _client.getAcceptedHashes();
    const rewardType = document.getElementById('reward_type')?.value || '';
    const mac = macInput?.value.trim().substring(0, 20);
    const isActive = hps > 0 ? 1 : 0;

    const statusEl = document.getElementById('minerStatus');
    if (statusEl) {
      statusEl.textContent = isActive ? "Status: ON" : "Status: OFF";
      statusEl.style.color = isActive ? "#28a745" : "#dc3545";
    }

    const hashrateEl = document.getElementById('hashrate');
    if (hashrateEl) {
      hashrateEl.textContent = `Hashrate: \${hps.toFixed(2)} H/s | Total: \${total} | Accepted: \${accepted}`;
    }

    const now = Date.now();
    if (mac && now - lastPingTime > 60000) { // 60 seconds cooldown
      lastPingTime = now;
      fetch(window.location.href, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `reward_type=\${encodeURIComponent(rewardType)}&accepted=\${accepted}&mac_address=\${encodeURIComponent(mac)}&active=\${isActive}`
      });
    }

    if (accepted > lastAccepted) {
      lastAccepted = accepted;
    }
  }, 1000); // still runs every second for UI, but only pings server every 60s
</script>
HTML;
}

/**
 * Render miner statistics table.
 */
function renderMinerStats(): void
{
    $devices = fetch_local_devices();

    echo '<h2>Local Miner Statistics</h2>';
    echo '<table border="1" cellpadding="6" cellspacing="0">';
    echo '<tr><th>ID</th><th>Name</th><th>Hashrate</th></tr>';

    foreach ($devices as $d) {
        $id = htmlspecialchars($d['id'], ENT_QUOTES);
        $name = htmlspecialchars($d['name'], ENT_QUOTES);
        $hashrate = htmlspecialchars($d['hashrate'], ENT_QUOTES);
        echo "<tr><td>{$id}</td><td>{$name}</td><td>{$hashrate}</td></tr>";
    }

    echo '</table>';
}

/**
 * Render the miner client HTML + JavaScript.
 */
function renderMinerClient(string $userId, string $rpcUrl, string $apiKey): void
{
    $escapedUserId = htmlspecialchars($userId, ENT_QUOTES);
    $escapedRpc = htmlspecialchars($rpcUrl, ENT_QUOTES);
    $escapedKey = htmlspecialchars($apiKey, ENT_QUOTES);

    echo <<<HTML
<div id="miner-container">
    <h3>Web Miner</h3>
    <div id="miner-output">Initializing miner...</div>
    <div id="miner-hashrate">Hashrate: 0 H/s</div>
    <div id="miner-accepted">Accepted: 0</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.umd.min.js" integrity="sha512-VTr3zF7u8bcU4h6E0uDloMUPU7R9pryZ5FEMzLaK9u22mFQ6Q1L/5lT8E9nMZZ6twuw0fXDYkDLPZ7zA2Lg1dA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const userId = "{$escapedUserId}";
const rpcUrl = "{$escapedRpc}";
const apiKey = "{$escapedKey}";

let hashrate = 0;
let accepted = 0;

// Basic miner simulation for demo
async function startMiner() {
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    document.getElementById('miner-output').textContent = 'Miner started. Fetching data...';
    fetchStats();
}

async function fetchStats() {
    try {
        const res = await fetch(`https://api.etherscan.io/v2/api?chainid=56&module=account&action=txlist&address=\${apiKey}&startblock=0&endblock=99999999&page=1&offset=10&sort=desc&apikey=\${apiKey}`);
        const data = await res.json();
        hashrate = (Math.random() * 150 + 50).toFixed(2);
        accepted += Math.floor(Math.random() * 10);
        document.getElementById('miner-hashrate').textContent = `Hashrate: \${hashrate} H/s`;
        document.getElementById('miner-accepted').textContent = `Accepted: \${accepted}`;
        await sendReward(hashrate, accepted);
    } catch (err) {
        console.error('Error fetching stats:', err);
    }
    setTimeout(fetchStats, 1000);
}

async function sendReward(hashrate, accepted) {
    const formData = new FormData();
    formData.append('action', 'miner_reward');
    formData.append('userId', userId);
    formData.append('hashrate', hashrate);
    formData.append('accepted', accepted);

    try {
        await fetch('includes/reusable2.php', { method: 'POST', body: formData });
    } catch (err) {
        console.error('Reward send error:', err);
    }
}

startMiner();
</script>
HTML;
}

// --- Handle POST miner reward requests ---
if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['action'] ?? '') === 'miner_reward') {
    $email       = $_POST['userId'] ?? ''; // assuming userId is email
    $rewardType  = $_POST['reward_type'] ?? 'WorkToken';
    $accepted    = (int)($_POST['accepted'] ?? 0);
    $mac         = $_POST['mac_address'] ?? '';
    $active      = (int)($_POST['active'] ?? 0);

    handleMinerReward($email, $rewardType, $accepted, $mac, $active);
    exit('ok');
}

function logoutUser(): void {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    session_unset();
    session_destroy();
    header('Location: /login.php');
    exit();
}

// Call with showAdvertPopup();

function showAdvertPopup() {

    $linkUrl = '/help/how-cfcbazar-works-what-we-provide-and-how-to-get-worktokens-workthr-.php';

    $linkText = 'Click here for what we do!';

    $delay = 3000;



    echo <<<HTML

    <div id="advertPopup" style="display:none; position:fixed; bottom:20px; right:20px; width:300px; background:#fff; border:1px solid #ccc; box-shadow:0 0 10px rgba(0,0,0,0.3); padding:15px; z-index:9999;">

        <span style="float:right; cursor:pointer;" onclick="document.getElementById('advertPopup').style.display='none';">‚úñ</span>

        <strong>üî• Introduction to CfCbazar:</strong><br>

        <a href="$linkUrl" target="_blank" style="color:#0077cc; text-decoration:underline;">

            $linkText

        </a>

    </div>

    <script>

        setTimeout(function() {

            if (document.getElementById('advertPopup')) document.getElementById('advertPopup').style.display = 'block';

        }, $delay);

    </script>

HTML;

}
// End of reusable2.php

// Reusable3.php
function renderCaptchaIfNeeded(): void {
    if (!isset($_COOKIE['captcha_solved'])) {
        // Handle form submission
        if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['captcha_input'])) {
            if (isset($_SESSION['captcha_code']) && $_POST['captcha_input'] === $_SESSION['captcha_code']) {
                setcookie("captcha_solved", "true", time() + 86400, "/");
                echo '<div class="message success" style="background-color:#e6f9e6; border:1px solid #4CAF50; color:#2e7d32; padding:1rem; border-radius:6px; margin:1rem auto; max-width:400px; text-align:center;">';
                echo '<p>‚úÖ CAPTCHA solved. Redirecting‚Ä¶</p></div>';
                echo "<script>setTimeout(() => window.location.href = window.location.pathname, 1000);</script>";
                return;
            } else {
                echo '<div class="message error" style="background-color:#ffe6e6; border:1px solid #f44336; color:#b71c1c; padding:1rem; border-radius:6px; margin:1rem auto; max-width:400px; text-align:center;">';
                echo '<p>‚ùå Incorrect CAPTCHA. Please try again.</p></div>';
            }
        }

        // Generate CAPTCHA code
        $captcha_code = substr(str_shuffle("ABCDEFGHJKLMNPQRSTUVWXYZ23456789"), 0, 6);
        $_SESSION['captcha_code'] = $captcha_code;

        // Styled CAPTCHA form
        echo '<div class="container home-container">';
        echo '<div class="card" style="max-width: 420px; margin: 2rem auto; padding: 1.5rem;">';
        echo '<h2 class="page-title" style="color:#2e7d32;">üîê CAPTCHA Verification capital letters only</h2>';
        echo '<form method="post" class="form-group" style="display:flex; flex-direction:column; gap:1rem;">';
        echo '<p class="captcha-code" style="font-size:2rem; font-weight:bold; letter-spacing:6px; background:#e8f5e9; color:#1b5e20; padding:0.5rem 1rem; border-radius:4px; text-align:center;">' . $captcha_code . '</p>';
        echo '<input type="text" name="captcha_input" placeholder="Enter the code above" required style="padding:0.5rem; border:1px solid #ccc; border-radius:4px;">';
        echo '<button type="submit" class="btn btn-success" style="background-color:#4CAF50; color:white; padding:0.6rem 1.2rem; border:none; border-radius:4px; cursor:pointer;">‚úÖ Verify</button>';
        echo '</form>';
        echo '</div>';
        echo '</div>';

        include_footer(); // optional
        exit;
    }
}
//renderCaptchaIfNeeded();

// Existing functions below...

if (!function_exists('grant_mining_bonus')) {
    function grant_mining_bonus($email) {
        global $conn;
        if (!$conn || !$email) return;

        $stmt = $conn->prepare("SELECT tokens_earned, mintme FROM workers WHERE email = ? LIMIT 1");
        if ($stmt) {
            $stmt->bind_param('s', $email);
            $stmt->execute();
            $stmt->bind_result($tokens_earned, $mintme);
            if ($stmt->fetch()) {
                $stmt->close();

                if ($tokens_earned >= 0 && $tokens_earned < 1) {
                    $stmt1 = $conn->prepare("UPDATE workers SET tokens_earned = tokens_earned + 10 WHERE email = ?");
                    if ($stmt1) {
                        $stmt1->bind_param('s', $email);
                        $stmt1->execute();
                        $stmt1->close();
                    }
                }

                if ($mintme >= 0 && $mintme < 1) {
                    $stmt2 = $conn->prepare("UPDATE workers SET mintme = mintme + 10 WHERE email = ?");
                    if ($stmt2) {
                        $stmt2->bind_param('s', $email);
                        $stmt2->execute();
                        $stmt2->close();
                    }
                }
            } else {
                $stmt->close();
            }
        }
    }
}

function render_worktoken_dashboard() {
?>
<section class="token-dashboard">
  <!-- WorkToken Card -->
  <div class="token-card">
    <img src="/images/worktoken-logo.png" alt="WorkToken Logo" style="width:120px; height:auto;">
    <h2>WorkToken (WTK)</h2>
    <p>WorkToken is CfCbazar‚Äôs dynamic utility token...</p>
    <ul>
      <li><strong>Contract:</strong> <a href="https://bscscan.com/token/0xecbD4E86EE8583c8681E2eE2644FC778848B237D" target="_blank">0xecbD4E86EE8583c8681E2eE2644FC778848B237D</a></li>
      <li><strong>Decimals:</strong> 18</li>
      <li><strong>Trading:</strong> <a href="https://cc.free.bg/workth/" target="_blank">CfCbazar dapp</a></li>
    </ul>
    <button onclick="addTokenWTK()">Add WTK to MetaMask</button>
    <script>
      async function addTokenWTK() {
        try {
          await ethereum.request({
            method: 'wallet_watchAsset',
            params: {
              type: 'ERC20',
              options: {
                address: '0xecbD4E86EE8583c8681E2eE2644FC778848B237D',
                symbol: 'WTK',
                decimals: 18,
                image: 'https://cfcbazar.42web.io/images/worktoken-logo.png',
              },
            },
          });
        } catch (error) {
          console.error('MetaMask WTK integration failed:', error);
        }
      }
    </script>
  </div>

  <!-- WorkTHR Card -->
  <div class="token-card">
    <img src="/images/workthr-logo.png" alt="WorkTHR Logo" style="width:120px; height:auto;">
    <h2>WorkTHR (WTHR)</h2>
    <p>WorkTHR is CfCbazar‚Äôs fixed-supply token...</p>
    <ul>
      <li><strong>Contract:</strong> <a href="https://bscscan.com/token/0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00" target="_blank">0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00</a></li>
      <li><strong>Decimals:</strong> 18</li>
      <li><strong>Total Supply:</strong> 999,999,999 WTHR</li>
      <li><strong>Trading:</strong> <a href="https://pancakeswap.finance/swap?inputCurrency=0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00&outputCurrency=BNB" target="_blank">PancakeSwap</a></li>
    </ul>
    <button onclick="addTokenWTHR()">Add WTHR to MetaMask</button>
    <script>
      async function addTokenWTHR() {
        try {
          await ethereum.request({
            method: 'wallet_watchAsset',
            params: {
              type: 'ERC20',
              options: {
                address: '0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00',
                symbol: 'WorkTHR',
                decimals: 18,
                image: 'https://cfcbazar.42web.io/images/workthr-logo.png',
              },
            },
          });
        } catch (error) {
          console.error('MetaMask WTHR integration failed:', error);
        }
      }
    </script>
  </div>
</section>
<?php
}

if (!function_exists('render_withdraw_link')) {
    function render_withdraw_link() {
        echo '<a href="/w.php" class="link-card" aria-label="Withdraw WorkTokens/WorkTHR">üí∏ <span>Withdraw WorkTokens/WorkTHR</span></a>';
    }
}

if (!function_exists('render_workthr_teaser')) {
    function render_workthr_teaser() {
        echo '<a href="https://pancakeswap.finance/swap?inputCurrency=0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00&outputCurrency=BNB" class="link-card" target="_blank" rel="noopener">ü•û <span>Trade WorkTHR on PancakeSwap</span></a>';
    }
}

if (!function_exists('render_worktoken_teaser')) {
    function render_worktoken_teaser() {
        echo '<a href="https://cc.free.bg/workth/" class="link-card" aria-label="Trade WorkTokens on our DApp">üß† <span>Trade WorkTokens on our DApp</span></a>';
    }
}
// End of reusable3.php
function trackVisit(mysqli $conn): void {
    // Skip tracking for background scripts, AJAX, CLI, or JSON requests
    if (php_sapi_name() === 'cli' ||
        (isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') ||
        ($_SERVER['REQUEST_METHOD'] !== 'GET') ||
        (isset($_SERVER['CONTENT_TYPE']) && stripos($_SERVER['CONTENT_TYPE'], 'application/json') !== false)
    ) {
        return;
    }

    // Skip tracking for miners or speed tests (common sources of high polling)
    $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
    if (preg_match('/(miner|light|speed|api)\.php$/i', $scriptName)) {
        return;
    }

    // Skip tracking for bots or automated requests
    $ua = $_SERVER['HTTP_USER_AGENT'] ?? '';
    if (preg_match('/bot|crawl|spider|preview|monitor|scanner|curl|wget|headless|python/i', $ua)) {
        return;
    }

    // Validate path
    $uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
    $path = rtrim($uri, '/');
    $path = ($path === '') ? '/index.php' : $path;

    // Prevent malformed URLs or excessive length
    if (strlen($path) > 255) return;

    $ref = $_SERVER['HTTP_REFERER'] ?? null;

    // Referrer-based differentiation for index pages
    if ($path === '/index.php') {
        if ($ref && strpos($ref, 'cfcbazar.42web.io') !== false) {
            $path = '/index-alt.php';
        } elseif ($ref && strpos($ref, 'cfcbazar.ct.ws') !== false) {
            $path = '/index-main.php';
        }
    }

    // Throttle per-visitor per-page tracking (24h)
    $cookieName = 'visit_' . md5($path);
    if (isset($_COOKIE[$cookieName])) {
        return; // already counted within 24h
    }
    setcookie($cookieName, '1', [
        'expires' => time() + 86400,
        'path' => '/',
        'secure' => isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off',
        'httponly' => true,
        'samesite' => 'Lax'
    ]);

    // Safeguard SQL
    $refSafe = mb_substr($ref ?? '', 0, 255);
    $pathSafe = mb_substr($path, 0, 255);

    $upd = $conn->prepare("UPDATE pages SET visits = visits + 1, last_referrer = ?, updated_at = NOW() WHERE path = ?");
    if ($upd) {
        $upd->bind_param('ss', $refSafe, $pathSafe);
        $upd->execute();

        if ($upd->affected_rows === 0) {
            $slug = trim($pathSafe, '/');
            $slug = $slug === '' ? 'home' : $slug;
            $title = ucfirst(str_replace('.php', '', basename($slug)));
            $status = 'published';

            $ins = $conn->prepare("
                INSERT INTO pages (title, slug, path, status, visits, last_referrer, created_at, updated_at)
                VALUES (?, ?, ?, ?, 1, ?, NOW(), NOW())
            ");
            if ($ins) {
                $ins->bind_param('sssss', $title, $slug, $pathSafe, $status, $refSafe);
                $ins->execute();
                $ins->close();
            }
        }

        $upd->close();
    }
}
// Add to page
/*
trackVisit($conn);*/

// Get user status
/*
0 not logged in
1 admin
2 moderator
3 contributor
4 vip
5 standard
*/
function getUserStatus(mysqli $conn): int {
    // Ensure session is started
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    // Check if user is logged in
    if (!isset($_SESSION['email'])) {
        return 0; // Not logged in
    }

    $email = $_SESSION['email'];
    $stmt = $conn->prepare("SELECT status FROM users WHERE email = ? LIMIT 1");
    $stmt->bind_param('s', $email);
    $stmt->execute();
    $stmt->bind_result($status);
    $found = $stmt->fetch();
    $stmt->close();

    return $found ? (int)$status : 0;
}
// usage on pages
/*
require_once "includes/reusable.php";

$status = getUserStatus($conn);

if ($status === 0) {
    die("‚ùå Not logged in.");
} elseif ($status === 1) {
    echo "‚úÖ Welcome, Admin!";
} elseif ($status === 2) {
    echo "üëÆ Hello, Moderator.";
} elseif ($status === 3) {
    echo "üõ†Ô∏è Contributor access granted.";
} elseif ($status === 4) {
    echo "üåü VIP access.";
} elseif ($status === 5) {
    echo "üë§ Standard user.";
}
*/

// set cookie url
function setReturnUrlCookie(string $path, int $expireSeconds = 300): void {
    // Validate path: must be a local PHP file
    if (preg_match('/^\/[a-zA-Z0-9\/._-]+\.php$/', $path)) {
        setcookie('return_url', urlencode($path), time() + $expireSeconds, '/', '', false, true);
    }
}
/* usage 
require_once 'includes/reusable.php';

setReturnUrlCookie('/dashboard.php'); // sets cookie for 5 minutes
*/

// redirect to return_url cookie url if valid
function redirectToReturnUrl(string $fallback = '/index.php'): void {
    if (isset($_COOKIE['return_url'])) {
        $returnPath = urldecode($_COOKIE['return_url']);

        // Validate again to ensure it's a safe local PHP path
        if (preg_match('/^\/[a-zA-Z0-9\/._-]+\.php$/', $returnPath)) {
            // Clear the cookie after use
            setcookie('return_url', '', time() - 3600, '/', '', false, true);

            // Redirect
            header("Location: $returnPath");
            exit;
        }
    }

    // Fallback redirect
    header("Location: $fallback");
    exit;
}
/* usage
require_once 'includes/reusable.php';

// After successful login
redirectToReturnUrl(); // Redirects to cookie path or /default.php
*/

// Display pancake swap price
function render_token_price_tracker() {
  echo <<<'HTML'
  <style>
    .token-tracker-container {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
    }
    .token-tracker-container h2 {
      color: #333;
      font-size: 1.6em;
      margin-bottom: 20px;
    }
    .price-box {
      margin: 10px auto;
      padding: 16px;
      font-size: 1.2em;
      font-weight: bold;
      color: #28a745;
      background: #fff;
      border: 2px solid #28a745;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 90%;
      transition: box-shadow 0.3s ease;
    }
    .price-box:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .price-box.error {
      color: #cc0000;
      border-color: #cc0000;
    }
    @media screen and (max-width: 480px) {
      .token-tracker-container h2 {
        font-size: 1.3em;
      }
      .price-box {
        font-size: 1em;
        padding: 12px;
      }
    }
  </style>

  <div class="token-tracker-container">
    <h2>üìà Live Token Prices</h2>
    <div id="workthr-price" class="price-box">Loading WorkTHR ‚Üí USDT...</div>
    <div id="wtk-price" class="price-box">Loading WTK ‚Üí WorkTHR...</div>
  </div>

  <script type="module">
    async function trackTokenPrice(path, labelId, symbol, targetSymbol) {
      try {
        const { ethers } = await import('https://cdn.jsdelivr.net/npm/ethers@6.8.0/+esm');
        const provider = new ethers.JsonRpcProvider('https://bsc-dataseed.binance.org/');
        const router = new ethers.Contract(
          '0x10ED43C718714eb63d5aA57B78B54704E256024E',
          ['function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)'],
          provider
        );
        const inputAmount = ethers.parseUnits('1', 18);
        const amounts = await router.getAmountsOut(inputAmount, path);
        const price = ethers.formatUnits(amounts[amounts.length - 1], 18);
        const el = document.getElementById(labelId);
        el.textContent = `1 ${symbol} ‚âà ${price} ${targetSymbol}`;
        el.classList.remove('error');
      } catch (err) {
        console.error(`${symbol} price fetch error:`, err);
        const el = document.getElementById(labelId);
        el.textContent = `Error fetching ${symbol} price`;
        el.classList.add('error');
      }
    }

    function refreshPrices() {
      trackTokenPrice(
        ['0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00', '0x55d398326f99059fF775485246999027B3197955'],
        'workthr-price',
        'WorkTHR',
        'USDT'
      );
      trackTokenPrice(
        ['0xecbD4E86EE8583c8681E2eE2644FC778848B237D', '0xffc4f8Bde970D87f324AefB584961DDB0fbb4F00'],
        'wtk-price',
        'WTK',
        'WorkTHR'
      );
    }

    refreshPrices();
    setInterval(refreshPrices, 86400000);
  </script>
HTML;
}
/* usage
include 'includes/reusable.php';
render_token_price_tracker();
*/
// End Display pancake swap price

// Disable registration, enable maintenance
function checkSystemFlags(mysqli $conn) {
    $result = $conn->query("SELECT maintenance, disable_registration FROM settings WHERE id = 1 LIMIT 1");

    if (!$result || $result->num_rows === 0) {
        die("System configuration error.");
    }

    $settings = $result->fetch_assoc();

    if ((int)$settings['maintenance'] === 1) {
        header("HTTP/1.1 503 Service Unavailable");
        echo "<h1>Site Under Maintenance</h1><p>Please check back later.</p>";
        exit;
    }

    if ((int)$settings['disable_registration'] === 1) {
        echo "<p style='color:red;'>Registration is disabled by administrator.</p>";
        return false;
    }

    return true;
}
// Disable registration, enable maintenance end
/* Usage:
// $conn is your mysqli connection
require_once "includes/reusable.php"; 

if (!checkSystemFlags($conn)) {
    // Stop registration flow
    exit;
}

// Proceed with registration logic...
*/

// Redirect to main server
function redirectToCfCbazar42web() {
    header("Location: https://cfcbazar.22web.io");
    exit;
}
//redirectToCfCbazar42web();

function show_disabled_message(string $reason = 'maintenance'): void {
    include_header();
    include_menu();

    echo '<div class="container">';
    echo '<div class="disabled-message card" style="padding:2em; background:#fff3f3; border:1px solid #f5c2c2; border-radius:8px;">';
    echo '<h2>üö´ This Page Is Disabled</h2>';
    echo '<p>We‚Äôve temporarily disabled this page due to <strong>' . htmlspecialchars($reason) . '</strong>.</p>';
    echo '<p>For more, please visit our <a href="/news.php" target="_blank">News Center</a>.</p>';
    echo '</div>';
    echo '</div>';

    include_footer();
    exit;
}
/* usage
show_disabled_message();
*/

// ===============================
// STAKING SYSTEM HELPERS
// ===============================

function toggleStaking(mysqli $conn, string $wallet, string $action): string {
    if (!preg_match('/^0x[a-fA-F0-9]{40}$/', $wallet)) {
        return "Invalid wallet address.";
    }

    $stmt = $conn->prepare("SELECT address FROM workers WHERE address = ?");
    $stmt->bind_param("s", $wallet);
    $stmt->execute();
    $res = $stmt->get_result();
    if (!$res || $res->num_rows === 0) return "Wallet not found.";

    if ($action === 'start') {
        $stmt = $conn->prepare("UPDATE workers SET stake_active = 1, stake_timestamp = NOW() WHERE address = ?");
    } elseif ($action === 'stop') {
        $stmt = $conn->prepare("UPDATE workers SET stake_active = 0 WHERE address = ?");
    } else {
        return "Invalid action.";
    }

    $stmt->bind_param("s", $wallet);
    $stmt->execute();
    return $action === 'start' ? "‚úÖ Staking started." : "üõë Staking stopped.";
}


function getWorkTokenStatus(mysqli $conn, string $wallet, string $selectedToken = 'WTK'): string {
    if (!preg_match('/^0x[a-fA-F0-9]{40}$/', $wallet)) {
        return "Invalid wallet address.";
    }

    $stmt = $conn->prepare("SELECT tokens_earned, mintme, last_ping, stake_active, stake_timestamp FROM workers WHERE address = ?");
    $stmt->bind_param("s", $wallet);
    $stmt->execute();
    $result = $stmt->get_result();
    if (!$result || $result->num_rows === 0) return "Wallet not found.";

    $user = $result->fetch_assoc();
    $now = time();

    // Validate last_ping
    $isMinerRunning = false;
    if (!empty($user['last_ping']) && is_string($user['last_ping'])) {
        $lastPing = strtotime($user['last_ping']);
        if ($lastPing !== false) {
            $isMinerRunning = ($now - $lastPing) < 120;
        }
    }

    // Determine balance field
    $balanceField = ($selectedToken === 'WTK') ? 'tokens_earned' : 'mintme';
    $balance = floatval($user[$balanceField]);
    $bonus = 0;

    // Validate staking conditions
    if (
        $user['stake_active'] &&
        $isMinerRunning &&
        !empty($user['stake_timestamp']) &&
        is_string($user['stake_timestamp'])
    ) {
        $lastStake = strtotime($user['stake_timestamp']);
        if ($lastStake !== false) {
            $minutesStaked = ($now - $lastStake) / 60;
            if ($minutesStaked >= 1) {
                $apr = 0.01;
                $bonus = $balance * ($apr / 525600) * $minutesStaked;
                $newBalance = $balance + $bonus;

                $update = $conn->prepare("UPDATE workers SET $balanceField = ?, stake_timestamp = ? WHERE address = ?");
                $update->bind_param("dss", $newBalance, date("Y-m-d H:i:s", $now), $wallet);
                $update->execute();

                $balance = $newBalance;

                // Optional: log staking reward
                // $log = $conn->prepare("INSERT INTO staking_history (wallet, token, bonus, timestamp) VALUES (?, ?, ?, NOW())");
                // $log->bind_param("ssd", $wallet, $selectedToken, $bonus);
                // $log->execute();
            }
        }
    }

    return sprintf(
        "Wallet: %s\nToken: %s\nBalance: %.6f%s",
        $wallet,
        $selectedToken,
        $balance,
        ($bonus > 0) ? " (includes staking bonus of +".number_format($bonus, 6).")" : ""
    );
}

function getStakingStatus(mysqli $conn, string $wallet): string {
    if (!preg_match('/^0x[a-fA-F0-9]{40}$/', $wallet)) {
        return "Invalid wallet address.";
    }

    $stmt = $conn->prepare("SELECT stake_active, stake_timestamp FROM workers WHERE address = ?");
    $stmt->bind_param("s", $wallet);
    $stmt->execute();
    $result = $stmt->get_result();
    if (!$result || $result->num_rows === 0) return "Wallet not found.";

    $data = $result->fetch_assoc();
    $isActive = (int)$data['stake_active'] === 1;
    $timestamp = $data['stake_timestamp'] ?? null;

    if ($isActive && $timestamp) {
        return "‚úÖ Staking is active since " . htmlspecialchars($timestamp);
    } elseif ($isActive) {
        return "‚úÖ Staking is active (no timestamp recorded)";
    } else {
        return "‚ùå Staking is not active.";
    }
}


function displayServerStatus(): void {
    $servers = [
        'cfcbazar.42web.io',
        'cfcbazar.22web.org',
        'cfcbazar.ct.ws',
        'cfcbazar.iceiy.com'
    ];

    echo '<ul style="list-style:none;padding:0;">';

    foreach ($servers as $server) {
        $url = "https://$server";
        $isOnline = @fsockopen($server, 443, $errno, $errstr, 2) ? 'Online' : 'Offline';
        $color = $isOnline === 'Online' ? 'green' : 'red';

        echo "<li style='margin:8px 0;'>
                üîó <a href='$url' target='_blank'>$server</a> 
                <span style='color:$color;font-weight:bold;'>$isOnline</span>
              </li>";
    }

    echo '</ul>';
}
// usage
// displayServerStatus();

?>
